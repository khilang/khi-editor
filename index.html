<!doctype html>
<html lang="en">
  <head>
    <meta charset="Utf-8">
    <title>Khi editor & preprocessor</title>
    <script type="module">
      import init, * as khi from "./khi.js";
      init();
      window.check_well_formed = khi.check_well_formed;
      window.preprocess_latex = khi.preprocess_latex;
      window.preprocess_html = khi.preprocess_html;
    </script>
    <script language="javascript" type="text/javascript" src="codemirror.js"></script>
    <link rel="stylesheet" type="text/css" href="codemirror.css">
    <script src="cm-modes/xml.js"></script>
    <script src="cm-modes/stex.js"></script>
    <script src="cm-modes/khi.js"></script>
    <link rel="stylesheet" href="cm-styles/khidark.css"/>
    <link rel="stylesheet" href="cm-styles/monokai.css"/>
    <script type="text/javascript">
      window.editor = "temp";
      window.result = "temp";

      function loadExample(path) {
        return fetch(path).then(response => response.text());
      }

      // Paste in a HTML preprocessor example.
      async function htmlExample() {
        result.setValue(await loadExample("examples/frontpage.html.khi"));
        result.setOption("mode", "application/khi");
        result.setOption("theme", "khidark");
      }

      async function xmlExample() { // XML example
        result.setValue(await loadExample("examples/fruits.xml.khi"));
        result.setOption("mode", "application/khi");
        result.setOption("theme", "khidark");
      }

      // Preprocess UDL to HTML.
      function processHtml() {
        let inp = editor.getValue();
        let out;
        try {
          out = preprocess_html(inp);
        } catch (error) {
          document.getElementById("alert").hidden = false;
          document.getElementById("alert").textContent = error;
          return;
        }
        document.getElementById("alert").hidden = true;
        document.getElementById("alert").textContent = "";
        result.setValue(out);
        result.setOption("mode", "text/html");
        result.setOption("theme", "monokai");
      }

      // Paste in a LaTeX preprocessor example.
      async function latexExample() {
        result.setValue(await loadExample("examples/equations.tex.khi"));
        result.setOption("mode", "application/khi");
        result.setOption("theme", "khidark");
      }

      // Preprocess UDL to LaTeX.
      function processLatex() {
        let inp = editor.getValue();
        let out;
        try {
          out = preprocess_latex(inp);
        } catch (error) {
          document.getElementById("alert").hidden = false;
          document.getElementById("alert").textContent = error;
          return;
        }
        document.getElementById("alert").hidden = true;
        document.getElementById("alert").textContent = "";
        result.setValue(out);
        result.setOption("mode", "text/x-stex");
        result.setOption("theme", "monokai");
      }

      function checkWellFormed() {
        let inp = editor.getValue();
        try {
          check_well_formed(inp);
          document.getElementById("alert").hidden = false;
          document.getElementById("alert").textContent = "Well formed";
        } catch (error) {
          document.getElementById("alert").hidden = false;
          document.getElementById("alert").textContent = error;
        }
      }

      window.addEventListener('DOMContentLoaded', () => {
        // Set up editor area.
        editor = CodeMirror.fromTextArea(document.getElementById("code"), {
          lineNumbers: true,
          mode: 'application/khi',
          matchBrackets: true,
          theme: "khidark"
        });
        editor.setSize("100%", "100%");
        editor.setOption("mode", "application/khi");
        // Set up preprocessor result area.
        result = CodeMirror.fromTextArea(document.getElementById("preprocess"), {
          lineNumbers: true,
          lineWrapping: true,
          matchBrackets: true,
          readOnly: true,
          theme: "khidark"
        });
        result.setSize("100%", "100%");
      });
    </script>
    <style>
      body {
        font-family: sans-serif;
      }
      button {
        color:white;
        border: 2px #333333 solid;
        margin-left: 0.10em;
        font-size: 0.66em;
        font-weight: bold;
      }
      button:hover {
        filter: brightness(125%);
      }
      .bt1 {
        background-color: #7F5200;
      }
      .bt2 {
        background-color:#444444;
      }
      .cmdline {
        margin: 3px;
        padding: 3px;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
      }
      .cmdbox {
        background-color:#555555;
        color:#dddddd;
        margin: 0.25em;
        padding: 0.25em;
        border: 2px solid #222222;
        display: flex;
        flex-direction: row;
        gap: 0.25em;
        align-items: center;
      }
    </style>
  </head>
  <body style="height: 1fr; display:flex; flex-direction:column; width:1fr; background-color:#383838">
    <div style="background-color:#444444">
      <h1 style="color:#dddddd; margin: 5pt; padding: 3px;">Khi editor & preprocessor</h1>
      <div class="cmdline">
        <div class="cmdbox">
          <b>Khi</b>
          <a href="https://github.com/khilang/khilang/blob/master/reference.md" target="_blank"><button class="bt2">ReferenceðŸ¡¥</button></a>
          <button class="bt2" onclick="checkWellFormed()">Well-formed?</button>
        </div>
        <div class="cmdbox">
          <b>XML/HTML</b>
          <a href="https://github.com/khilang/khi.rs/blob/master/src/html/README.md" target="_blank"><button class="bt2">ReferenceðŸ¡¥</button></a>
          <button class="bt1" onclick="processHtml()">â–¶ Preprocess</button>
          <button class="bt2" onclick="htmlExample()">HTML Example</button>
          <button class="bt2" onclick="xmlExample()">XML Example</button>
        </div>
        <div class="cmdbox">
          <b>LaTeX</b>
          <a href="https://github.com/khilang/khi.rs/blob/master/src/tex/README.md" target="_blank"><button class="bt2">ReferenceðŸ¡¥</button></a>
          <button class="bt1" onclick="processLatex()">â–¶ Preprocess</button>
          <button class="bt2" onclick="latexExample()">Example</button>
        </div>
      </div>
      <div id="alert" style="color:white; padding: 0.5em; border:2px dotted grey; border-bottom:0px;" hidden>

      </div>
      <div style="max-width: 1fr; min-width:1fr; width:1fr; height: 1fr; display: grid; grid-template-columns: 2fr 2fr; align-items:stretch;border:2px dotted grey;">
        <div style="resize:horizontal; width: 100%; height: 100%;">
          <textarea id="code" name="code" style=""></textarea>
        </div>
        <div style="resize:horizontal; width: 1fr; height: 1fr;border-left:2px dotted grey;">
          <textarea id="preprocess" name="preprocess"></textarea>
        </div>
      </div>
    </div>
  </body>
</html>
